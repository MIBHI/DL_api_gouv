<!DOCTYPE html>
<html lang="fr" manifest="manifest.appcache">
    <head>
        <meta charset="utf-8">
        <title>Application Api</title>
        <meta name="description" content="CSS only mobile first navigation">

        <!-- Toutes les icônes -->
        <link rel="apple-touch-icon" href="img/fuel.png">
        <link rel="apple-touch-icon" href="img/touch-icon-iphone.png">
        <link rel="apple-touch-icon" sizes="76x76" href="img/fuel.png">
        <link rel="apple-touch-icon" sizes="120x120" href="img/fuel.png">
        <link rel="apple-touch-icon" sizes="152x152" href="img/fuel.png">
        <link rel="apple-touch-startup-image" href="img/fuel.png">

        <!-- Le meta magique pour les appareils mobiles -->
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
     
        <!--css-->
        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/style.css">

        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->    

        <!-- Favicons-->
        <link rel="shortcut icon" href="img/favicon.ico">
    </head>

    <body id="home"> 
        <div class="wrapper">     
            <header> 
                <h1 class="logo"><a href="">Nav</a></h1>             
                <a class="to_nav" href="#primary_nav" onclick="toggleMenu()" >Menu</a>             
            </header>

            <nav id="primary_nav"> 
                <ul>             
                    <li><a href="#">Portfolio</a></li>
                    <li><a href="#">About Me</a></li>
                    <li><a href="#">Nonsense</a></li>
                    <li><a href="#">Services</a></li>
                    <li><a href="#">Contact</a></li>
                    <li class="top"><a href="#home">Top</a></li>             
                </ul>             
            </nav><!--end primary_nav-->
     
            <div class="core">
                <form class="form-app">
                    <div class="form-group">
                        <input class="form-control input-app" type="text" id="cp" placeholder="Code postale" onkeyup="makeCorsRequest()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0">
                        <select name="type" id="type" class="form-control input-app" onchange="makeCorsRequest()">
                            <option>Type</option>
                            <option value="gazole">Gazole</option>
                            <option value="e10">E10</option>
                            <option value="e85">E85</option>
                            <option value="sp95">SP95</option>
                            <option value="sp98">SP98</option>
                            <option value="gpl">GPL</option>
                        </select>
                    </div>
                </form>

                <div id="reponse">
                    <div id="dataDisplay"></div>
                </div>
            </div>
     
        </div><!--end wrapper-->

        <footer>
            <p>Copyright © 2016 Mouy M - Austoni M</p>
        </footer>
     

        <script>

            function toggleMenu() {
                var found = false;
                var menu = document.getElementById("primary_nav");

                for (var i = 0; i <= menu.classList.length-1; i++) {

                    if (menu.classList[i]=="active"){
                        
                        found=true;
                        break;
                    } 
                }

                if (found) {

                    menu.classList.remove("active");
                } else {

                    menu.classList.add("active");
                }
            }

            function getUrl(){
                return 'http://192.168.1.127:8080/api/DL_api_gouv/api/?cp='+document.getElementById("cp").value+'&type='+document.getElementById("type").value;
            }

            // Create the XHR object.
            function createCORSRequest(method, url) {
                var xhr = new XMLHttpRequest();
                if ("withCredentials" in xhr) {
                    // XHR for Chrome/Firefox/Opera/Safari.
                    xhr.open(method, url, true);
                } else if (typeof XDomainRequest != "undefined") {
                    // XDomainRequest for IE.
                    xhr = new XDomainRequest();
                    xhr.open(method, url);
                } else {
                    // CORS not supported.
                    xhr = null;
                }
                return xhr;
            }

            // Make the actual CORS request.
            function makeCorsRequest() {

                //If input length is > 5 & select is not empty
                if ( document.getElementById('cp').value.length == 5 && document.getElementById("type").value.length != 0 && document.getElementById("type").value != 'Type'){

                    //Clean data
                    document.getElementById('dataDisplay').innerHTML = '';

                    //Display loader and hide data
                    document.getElementById('dataDisplay').style.display = "block";
                    document.getElementById('dataDisplay').setAttribute("class", "loader");

                    // This is a sample server that supports CORS.
                    var xhr = createCORSRequest('GET', getUrl());

                    if (!xhr) {
                        alert('CORS not supported');
                        return;
                    }

                    // Response handlers.
                    xhr.onload = function() {

                        //Array objet of data
                        var data = JSON.parse(xhr.responseText);

                        //Display data if status if ok
                        if (data.status === 'ok'){
                            for (var i = 0; i < data.results.length; i++) {
                                document.getElementById('dataDisplay').innerHTML += '<strong><span style="color: #ec971f" class="glyphicon glyphicon-map-marker" aria-hidden="true"></span> </strong> '+data.results[i].addr+'<br>';
                                document.getElementById('dataDisplay').innerHTML += '<strong><span style="color: greenyellow" class="glyphicon glyphicon-usd" aria-hidden="true"></span> </strong>'+data.results[i].price+'<br><br>';
                            }
                        }else{
                            //TODO ERRO MESSAGE
                        }

                        //Hide loader and display data
                        document.getElementById('dataDisplay').setAttribute("class", "");
                        document.getElementById('dataDisplay').style.display = "block";

                    };

                    xhr.onerror = function() {
                        document.getElementById('dataDisplay').innerHTML = "Attention ! Vous n'etes plus connecté à internet, Veuillez reactualiser la page pour acceder aux données" ;
                    };

                    xhr.send();
                }else {
                    //Hide dataDisplay
                    document.getElementById('dataDisplay').style.display = "none";
                }
            }

        </script>

    </body>
</html>