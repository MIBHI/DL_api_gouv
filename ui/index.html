<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>Application Api</title>
        <meta name="description" content="CSS only mobile first navigation">

        <!-- Toutes les icônes -->
        <link rel="apple-touch-icon" href="img/fuel.png">
        <link rel="apple-touch-icon" href="img/touch-icon-iphone.png">
        <link rel="apple-touch-icon" sizes="76x76" href="img/fuel.png">
        <link rel="apple-touch-icon" sizes="120x120" href="img/fuel.png">
        <link rel="apple-touch-icon" sizes="152x152" href="img/fuel.png">
        <link rel="apple-touch-startup-image" href="img/fuel.png">

        <!-- Le meta magique pour les appareils mobiles -->
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
     
        <!--css-->
        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/style.css">

        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->    

        <!-- Favicons-->
        <link rel="shortcut icon" href="favicon.ico">     
    </head>

    <body id="home"> 
        <div class="wrapper">     
            <header> 
                <h1 class="logo"><a href="">Nav</a></h1>             
                <a class="to_nav" href="#primary_nav" onclick="toggleMenu()" >Menu</a>             
            </header>

            <nav id="primary_nav"> 
                <ul>             
                    <li><a href="">Portfolio</a></li>             
                    <li><a href="">About Me</a></li>             
                    <li><a href="">Nonsense</a></li>             
                    <li><a href="#" onclick="getApi();return false;">Services</a></li>             
                    <li><a href="">Contact</a></li>             
                    <li class="top"><a href="#home">Top</a></li>             
                </ul>             
            </nav><!--end primary_nav-->
     
            <div style="margin: 100px 0">
                <div class="form-inline">
                    <div class="form-group">
                        <div class="input-group">
                            <input class="form-control" type="text" id="cp" placeholder="Code postale" onkeyup="makeCorsRequest()">
                        </div>
                        <div class="input-group">
                            <select name="type" id="type" class="form-control" onchange="makeCorsRequest()">
                                <option>Type</option>
                                <option value="gazole">Gazole</option>
                                <option value="e10">E10</option>
                                <option value="e85">E85</option>
                                <option value="sp95">SP95</option>
                                <option value="sp98">SP98</option>
                                <option value="gpl">GPL</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="reponse">
                    <img id="loader" src="img/loader.gif" alt="" style="display: none">
                    <div id="dataDisplay"></div>
                </div>
            </div>
     
            <footer>     
                <p>Copyright © 2016 Mouy M - Austoni M</p>
            </footer>
     
        </div><!--end wrapper-->
     

        <script>

            function toggleMenu() {
                var found = false;
                var menu = document.getElementById("sendRequest");

                for (var i = 0; i <= menu.classList.length-1; i++) {

                    if (menu.classList[i]=="active"){
                        
                        found=true;
                        break;
                    } 
                }

                if (found) {

                    menu.classList.remove("active");
                } else {

                    menu.classList.add("active");
                }
            }

            function toggleResponse() {
                var found = false;
                var response = document.getElementById("reponse");

                for (var i = 0; i <= response.classList.length-1; i++) {

                    if (response.classList[i]=="active"){

                        found=true;
                        break;
                    }
                }

                if (found) {
                    response.classList.remove("active");
                } else {
                    response.innerHTML = "Chargement...";
                    response.classList.add("active");
                }
            }

            function getUrl(){
                return 'http://localhost/DL_api_gouv/api/?cp='+document.getElementById("cp").value+'&type='+document.getElementById("type").value;
            }

            // Create the XHR object.
            function createCORSRequest(method, url) {
                var xhr = new XMLHttpRequest();
                if ("withCredentials" in xhr) {
                    // XHR for Chrome/Firefox/Opera/Safari.
                    xhr.open(method, url, true);
                } else if (typeof XDomainRequest != "undefined") {
                    // XDomainRequest for IE.
                    xhr = new XDomainRequest();
                    xhr.open(method, url);
                } else {
                    // CORS not supported.
                    xhr = null;
                }
                return xhr;
            }

            // Make the actual CORS request.
            function makeCorsRequest() {
                // This is a sample server that supports CORS.
                var xhr = createCORSRequest('GET', getUrl());

                if (!xhr) {
                    alert('CORS not supported');
                    return;
                }

                // Response handlers.
                xhr.onload = function() {

                    //Clean data
                    document.getElementById('dataDisplay').innerHTML = '';

                    //Display loader and hide data
                    document.getElementById('dataDisplay').style.display = "none";
                    document.getElementById('loader').style.display = "block";

                    //Array objet of data
                    var data = JSON.parse(xhr.responseText);

                    //Display data if status if ok
                    if (data.status === 'ok'){
                        for (var i = 0; i < data.results.length; i++) {
                            document.getElementById('dataDisplay').innerHTML += 'Adresse : '+data.results[i].addr+'<br>';
                            document.getElementById('dataDisplay').innerHTML += 'Prix : '+data.results[i].price+'<br>';
                        }
                    }else{
                        //TODO ERRO MESSAGE
                    }

                    //Hide loader and display data
                    document.getElementById('loader').style.display = "none";
                    document.getElementById('dataDisplay').style.display = "block";

                };

                xhr.onerror = function() {
                    document.getElementById('reponse').innerHTML = "Attention ! Vous n'etes plus connecté à internet, Veuillez reactualiser la page pour acceder aux données" ;
                };

                xhr.send();
            }

        </script>

    </body>
</html>